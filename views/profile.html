<!DOCTYPE html>
<html lang="en">
  <head>
      <meta charset="utf-8" />
      <meta name="viewport" content="width=device-width, initial-scale=1" />
      <meta name="author" content="Neil Ricci">

      <title>Beam, a personal finance visualizer</title>

      <!-- Bootstrap core CSS -->
      <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-eOJMYsd53ii+scO/bJGFsiCZc+5NDVN2yr8+0RDqr0Ql0h+rP48ckxlpbzKgwra6" crossorigin="anonymous">

      <link rel="stylesheet" type="text/css" href="/css/profile.css">
  </head>
  <body>
    <div class="container px-4 py-5">
      <header class="d-flex justify-content-between border-bottom mb-3">
        <div class="mb-3 mb-md-0">
          <h1>Beam</h1>
        </div>
        <div>
          <button type="button" class="btn btn-outline-dark" id="sign-out">Sign out</button>
        </div>
      </header>
      <main class="row">
        <div class="d-grid gap-2 col-6 mx-auto">
          <button id="link-btn" class="btn btn-lg btn-dark" type="button" disabled>Connect with Plaid</button>
        </div>
        <div class="col-6">

        </div>
      </main>
    </div>

    <script src="/js/jquery.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/js/bootstrap.bundle.min.js" integrity="sha384-JEW9xMcG8R+pH31jmWH6WWP0WintQrMb4s7ZOdauHnUtxwoG2vI5DkLtS3qm9Ekf" crossorigin="anonymous"></script>

    <!-- The core Firebase JS SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.6.5/firebase-app.js"></script>

    <!-- Firebase products
        https://firebase.google.com/docs/web/setup#available-libraries -->
    <script src="https://www.gstatic.com/firebasejs/8.6.5/firebase-analytics.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.5/firebase-auth.js"></script>

    <script>
      // App's Firebase configuration
      const firebaseConfig = {
        apiKey: "AIzaSyCpUO4xRTzabMqfxfEPU7HlUVO22yfyb3A",
        authDomain: "beam-94bf1.firebaseapp.com",
        projectId: "beam-94bf1",
        storageBucket: "beam-94bf1.appspot.com",
        messagingSenderId: "119980617646",
        appId: "1:119980617646:web:74d17808d0aaf52161223f",
        measurementId: "G-LVZ03X1S6X"
      };
      // Initialize Firebase
      firebase.initializeApp(firebaseConfig);
      firebase.analytics();
    </script>

    <script>
      $(function() {
        $(".container").fadeIn()
      });

      firebase.auth().onAuthStateChanged((user) => {
        if (true) {
          // User is signed in, see docs for a list of available properties
          // https://firebase.google.com/docs/reference/js/firebase.User
          const uid = user.uid;
          getLinkToken(uid)
        } else {
          location.href = '/';
        }
      });

      $("#sign-out").click((param) => {
        console.log(param);
        firebase.auth().signOut();
      })
    </script>

    <script src="/data/financialData.js"></script>

    <script src="https://cdn.plaid.com/link/v2/stable/link-initialize.js"></script>

    <script>
      function getLinkToken(uid) {
        fetch('/api/link_token/get', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify( {"uid": uid } ),
        })
        .then(response => response.json())
        .then(data => initializeLinkSession(data.linkToken))
      }

      function initializeLinkSession(token) {
        const handler = Plaid.create({
          token: token,
          onSuccess: (public_token, metadata) => {
            fetch('/api/access_token/set', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify( {"public_token": public_token } ),
            })
            .then(response => response.json())
            .then(data => console.log(data))
          },
          onLoad: () => {},
          onExit: (err, metadata) => {},
          onEvent: (eventName, metadata) => {},
          receivedRedirectUri: null,
        });

        $('#link-btn').on('click', function(e) {
          if (handler != null) {
            handler.open();
          }
        });

        $('#link-btn').attr('disabled', false);
      }
    </script>
  </body>
</html>
